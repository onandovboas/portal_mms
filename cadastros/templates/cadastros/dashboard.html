{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard do Administrador</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="{% static 'cadastros/dashboard.css' %}" rel="stylesheet">
</head>
<body class="bg-light">

  <!-- Header -->
  <header class="sticky-top-blur">
    <div class="container content-wrap d-flex justify-content-between align-items-center py-2 flex-wrap gap-2">
      <div>
        <h1 class="h4 mb-0">Dashboard</h1>
        <small class="text-muted">Administração</small>
      </div>
      <div class="btn-wrap d-flex align-items-center">
        <a href="{% url 'relatorio_professores' %}" class="btn btn-secondary btn-sm"><i class="bi bi-people me-1"></i> Relatório de Professores</a>
        <a href="{% url 'venda_livro' %}" class="btn btn-info btn-sm"><i class="bi bi-bag-check me-1"></i> Vender Material</a>
        <a href="{% url 'lancamento_recebimento' %}" class="btn btn-primary btn-sm"><i class="bi bi-cash-coin me-1"></i> Lançar Recebimento</a>
        <form action="{% url 'logout' %}" method="post" class="m-0">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger btn-sm w-100"><i class="bi bi-box-arrow-right me-1"></i> Sair</button>
        </form>
      </div>
    </div>
  </header>

  <main class="container content-wrap mt-3">
    <div class="accordion mb-3" id="dashboardAccordion">

      <!-- Renovações (fechada por padrão) -->
      <div class="accordion-item card-section">
        <h2 class="accordion-header" id="headRenovacoes">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRenovacoes" aria-expanded="false" aria-controls="collapseRenovacoes">
            Alerta de Renovações (Próximos 30 dias)
          </button>
        </h2>
        <div id="collapseRenovacoes" class="accordion-collapse collapse" aria-labelledby="headRenovacoes" data-bs-parent="#dashboardAccordion">
          <div class="accordion-body">
            {% include "cadastros/includes/table_card_stack.html" with table_id="tbl-renovacoes" headers=headers_renovacoes rows_template="cadastros/includes/rows_renovacoes.html" items=contratos_a_vencer empty_text="Nenhum contrato vencendo nos próximos 30 dias." %}
          </div>
        </div>
      </div>

      <!-- Faltas Pendentes -->
      <div class="accordion-item card-section">
        <h2 class="accordion-header" id="headFaltas">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFaltas" aria-expanded="false" aria-controls="collapseFaltas">
            Acompanhamentos de Faltas Pendentes
          </button>
        </h2>
        <div id="collapseFaltas" class="accordion-collapse collapse" aria-labelledby="headFaltas" data-bs-parent="#dashboardAccordion">
          <div class="accordion-body">
            {% for acompanhamento in acompanhamentos_pendentes %}
            <form action="{% url 'resolver_acompanhamento' pk=acompanhamento.pk %}" method="post" class="mb-3 p-3 border rounded bg-white">
              {% csrf_token %}
              <p class="mb-1"><strong>Aluno:</strong> {{ acompanhamento.aluno.nome_completo }}</p>
              <p class="mb-1"><strong>Telefone:</strong> {{ acompanhamento.aluno.telefone|default:'não cadastrado' }}</p>
              <p class="mb-2 text-muted"><strong>Alerta:</strong> <time datetime="{{ acompanhamento.criado_em|date:'Y-m-d' }}">{{ acompanhamento.criado_em|date:"d/m/Y" }}</time> – {{ acompanhamento.numero_de_faltas }} faltas consecutivas</p>
              <div class="mb-2">
                <label for="motivo-{{ acompanhamento.pk }}" class="form-label">Motivo das Faltas e Ações Tomadas</label>
                <textarea name="motivo" id="motivo-{{ acompanhamento.pk }}" class="form-control" rows="2" placeholder="Ex.: contato realizado em 01/09, retorno combinado, justificativa de saúde"></textarea>
              </div>
              <div class="d-grid d-sm-flex gap-2">
                <button type="submit" class="btn btn-info btn-sm">Marcar como Resolvido</button>
              </div>
            </form>
            {% empty %}
            <p class="text-center text-muted">Nenhum acompanhamento de faltas pendente. Ótimo trabalho!</p>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Experimentais -->
      <div class="accordion-item card-section">
        <h2 class="accordion-header" id="headExperimental">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExperimental" aria-expanded="false" aria-controls="collapseExperimental">
            Alunos em Aula Experimental
            <span class="badge bg-info text-dark ms-2">{% if inscricoes_experimentais %}{{ inscricoes_experimentais.count }}{% else %}0{% endif %}</span>
          </button>
        </h2>
        <div id="collapseExperimental" class="accordion-collapse collapse" aria-labelledby="headExperimental" data-bs-parent="#dashboardAccordion">
          <div class="accordion-body">
            {% include "cadastros/includes/table_card_stack.html" with table_id="tbl-experimentais" headers=headers_experimentais rows_template="cadastros/includes/rows_experimentais.html" items=inscricoes_experimentais empty_text="Nenhum aluno em aula experimental no momento." %}
          </div>
        </div>
      </div>

    </div>

    <!-- Status Financeiro -->
    <div id="financeiro-top" class="d-flex justify-content-between align-items-center my-3 flex-wrap gap-2">
      <h3 class="h5 mb-0">Status Financeiro – {{ data_selecionada|date:"F \d\e Y" }}</h3>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="input-group input-group-sm" style="max-width: 320px;">
          <span class="input-group-text" id="search-all" aria-hidden="true"><i class="bi bi-search"></i></span>
          <input type="search" id="globalSearch" class="form-control" placeholder="Buscar aluno ou descrição..." aria-label="Buscar por aluno ou descrição">
        </div>
        <div class="btn-group btn-group-sm" role="group" aria-label="Navegar por mês">
          <a href="{% url 'dashboard_admin' %}?ano={{ nav.ano_anterior }}&mes={{ nav.mes_anterior }}#financeiro-top" class="btn btn-outline-secondary" aria-label="Mês anterior" data-preserve-scroll>&larr;</a>
          <a href="{% url 'dashboard_admin' %}?ano={{ nav.ano_seguinte }}&mes={{ nav.mes_seguinte }}#financeiro-top" class="btn btn-outline-secondary" aria-label="Próximo mês" data-preserve-scroll>&rarr;</a>
        </div>
      </div>
    </div>

    {% include 'cadastros/includes/filters_financeiro.html' %}

    <!-- Pagamentos Pendentes -->
    <section class="card mb-3 card-section" aria-labelledby="sec-pendentes">
      <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
        <h4 id="sec-pendentes" class="mb-0">Pagamentos Pendentes <span class="badge bg-dark-subtle text-dark ms-1">{{ pagamentos_pendentes|length }}</span></h4>
        <div class="d-flex flex-wrap align-items-center gap-2">
          <label for="sort-pendentes" class="form-label m-0 small">Ordenar:</label>
          <select id="sort-pendentes" class="form-select form-select-sm">
            <option value="az" selected>Aluno A→Z</option>
            <option value="za">Aluno Z→A</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        {% include "cadastros/includes/table_card_stack.html" with table_id="tabela-pendentes" headers=headers_pendentes rows_template="cadastros/includes/rows_pendentes.html" items=pagamentos_pendentes empty_text="Nenhum pagamento pendente para este mês." %}
      </div>
    </section>

    <!-- Pagamentos Recebidos -->
    <section class="card mb-4 card-section" aria-labelledby="sec-recebidos">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h4 id="sec-recebidos" class="mb-0">Pagamentos Recebidos <span class="badge bg-light text-dark ms-1">{{ pagamentos_pagos|length }}</span></h4>
        <div class="d-flex align-items-center gap-2">
          <label for="sort-recebidos" class="form-label m-0 small text-white-50">Ordenar:</label>
          <select id="sort-recebidos" class="form-select form-select-sm">
            <option value="az" selected>Aluno A→Z</option>
            <option value="za">Aluno Z→A</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        {% include "cadastros/includes/table_card_stack.html" with table_id="tabela-recebidos" headers=headers_recebidos rows_template="cadastros/includes/rows_recebidos.html" items=pagamentos_pagos empty_text="Nenhum pagamento recebido para este mês." %}
      </div>
    </section>
  </main>

  <!-- Toast container (mantido para feedback de ações futuras) -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="liveToast" class="toast align-items-center text-bg-success border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Operação concluída.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Preserva rolagem
    (function(){
      const KEY = 'dash-scroll';
      document.querySelectorAll('a[data-preserve-scroll]').forEach(a => a.addEventListener('click', () => sessionStorage.setItem(KEY, String(window.scrollY))));
      const y = sessionStorage.getItem(KEY); if (y !== null) { window.scrollTo(0, parseInt(y, 10) || 0); sessionStorage.removeItem(KEY); }
    })();

    // Ordenação robusta por cabeçalho "Aluno"
    (function(){
      function sortByHeader(sectionTitleId, selectId, headerText){
        const title = document.getElementById(sectionTitleId); const select = document.getElementById(selectId);
        if (!title || !select) return; const section = title.closest('section'); const table = section?.querySelector('table'); if (!table) return;
        const ths = Array.from(table.tHead?.rows?.[0]?.cells || []);
        const idx = ths.findIndex(th => (th.innerText || '').trim().toLowerCase() === headerText.toLowerCase()); if (idx < 0) return;
        function apply(){ const tbody = table.tBodies[0]; if (!tbody) return; const rows = Array.from(tbody.rows);
          rows.sort((a,b)=>{ const ta = (a.cells[idx]?.innerText || '').trim().toLowerCase(); const tb = (b.cells[idx]?.innerText || '').trim().toLowerCase(); return select.value === 'az' ? ta.localeCompare(tb) : tb.localeCompare(ta); });
          rows.forEach(r => tbody.appendChild(r)); }
        select.addEventListener('change', apply); apply();
      }
      sortByHeader('sec-pendentes','sort-pendentes','Aluno');
      sortByHeader('sec-recebidos','sort-recebidos','Aluno');
    })();

    // Busca global
    (function(){
      const q = document.getElementById('globalSearch'); if (!q) return;
      function filterTable(table, term){ const rows = table?.querySelectorAll('tbody tr') || []; rows.forEach(tr => { const text = (tr.innerText || '').toLowerCase(); tr.style.display = !term || text.includes(term) ? '' : 'none'; }); }
      const pendSection = document.getElementById('sec-pendentes')?.closest('section'); const recSection  = document.getElementById('sec-recebidos')?.closest('section');
      function apply(){ const term = q.value.trim().toLowerCase(); filterTable(pendSection?.querySelector('table'), term); filterTable(recSection?.querySelector('table'), term); }
      q.addEventListener('input', apply);
    })();
  </script>
</body>
</html>