{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Corrigir Prova</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Work+Sans:wght@400;500&display=swap" rel="stylesheet">
  <link href="{% static 'cadastros/mms_style.css' %}" rel="stylesheet">
  {% if request.resolver_match.url_name == 'dashboard_admin' %}
      <link href="{% static 'cadastros/dashboard.css' %}" rel="stylesheet">
  {% endif %}
</head>
<body class="bg-light">
  <div class="container my-4">
    <header class="mb-4">
      <h1 class="h3">Folha de Correção Digital</h1>
      <p class="text-muted">Aluno: <strong>{{ aluno_prova.aluno.nome_completo }}</strong> | Prova: <strong>{{ aluno_prova.prova_template.titulo }}</strong></p>
    </header>

    <form method="post">
      {% csrf_token %}
      
      <div class="accordion" id="accordionCorrecao">
        {% for secao in secoes_para_correcao %}
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading-{{ forloop.counter }}">
              <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ forloop.counter }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}">
                <strong>Part: {{ secao.titulo }}</strong>
              </button>
            </h2>
            <div id="collapse-{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" data-bs-parent="#accordionCorrecao">
              <div class="list-group list-group-flush">
                {% for item in secao.questoes %}
                  <div class="list-group-item py-3">
                    <h5 class="mb-1">Q{{ item.questao.ordem }}: {{ item.questao.enunciado }}</h5>
                    <small class="text-muted">({{ item.questao.get_tipo_questao_display }} - Vale: {{ item.questao.pontos }} pontos)</small>
                    
                    <div class="card bg-light mt-2">
                      <div class="card-header small">Resposta do Aluno</div>
                      <div class="card-body">
                        <p class="card-text">
                          {% if item.resposta %}
                            {% if item.resposta.resposta_texto %}
                              {{ item.resposta.resposta_texto|linebreaksbr }}
                            {% elif item.texto_da_opcao %}
                              Opção selecionada: <strong>{{ item.texto_da_opcao }}</strong>
                            {% elif item.resposta.resposta_opcao %}
                              Opção selecionada: <strong>{{ item.resposta.resposta_opcao|upper }}</strong>
                            {% else %}<em class="text-muted">Não respondeu.</em>{% endif %}
                          {% else %}<em class="text-muted">Não respondeu.</em>{% endif %}
                        </p>
                      </div>
                    </div>

                    
                    <div class="row g-2 mt-2 align-items-center">
                      
                      {% if item.questao.tipo_questao == 'dictation' or item.questao.tipo_questao == 'dissertativa' or item.questao.tipo_questao == 'error_correction' or item.questao.tipo_questao == 'gap_fill' %}
                        
                        <div class="col-12 mt-3">
                          <label class="form-label fw-bold">Correção (selecione o texto e clique no botão):</label>
                          
                          <div class="btn-group btn-group-sm mb-1" role="group">
                            <button type="button" class="btn btn-danger btn-grifar" data-target="editor-{{ item.questao.id }}">
                                <i class="bi bi-highlighter"></i> Grifar em Vermelho
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-ungrifar" data-target="editor-{{ item.questao.id }}">
                                <i class="bi bi-eraser-fill"></i> Tirar Grifo
                            </button>
                          </div>
                          <div id="editor-{{ item.questao.id }}" 
                               class="form-control editor-corrigir" 
                               style="height: 150px; overflow-y: auto; background: #fff;" 
                               contenteditable="true">
                               {{ item.resposta.resposta_texto|default:"" }}
                          </div>

                          <input type="hidden" 
                                 name="resposta_corrigida_{{ item.questao.id }}" 
                                 id="hidden-editor-{{ item.questao.id }}">
                        </div>

                        <div class="col-md-3 mt-3">
                          <label for="pontos_{{ item.questao.id }}" class="form-label">Nota da Questão:</label>
                          <input type="number" step="0.5" name="pontos_{{ item.questao.id }}" id="pontos_{{ item.questao.id }}" class="form-control" max="{{ item.questao.pontos }}" min="0" value="0">
                        </div>
                        <div class="col-md-9 mt-3">
                          <label for="feedback_{{ item.questao.id }}" class="form-label">Feedback (opcional):</label>
                          <input type="text" name="feedback_{{ item.questao.id }}" id="feedback_{{ item.questao.id }}" class="form-control" placeholder="Ex: Cuidado com a conjugação...">
                        </div>
                        
                      {% else %}
                        <div class="col-md-3">
                          <label class="form-label">Correção:</label>
                          <div class="btn-group w-100">
                            <input type="radio" class="btn-check" name="pontos_{{ item.questao.id }}" id="certo-{{ item.questao.id }}" value="{{ item.questao.pontos }}" autocomplete="off">
                            <label class="btn btn-outline-success" for="certo-{{ item.questao.id }}">Certo</label>
                            
                            <input type="radio" class="btn-check" name="pontos_{{ item.questao.id }}" id="errado-{{ item.questao.id }}" value="0" autocomplete="off" checked>
                            <label class="btn btn-outline-danger" for="errado-{{ item.questao.id }}">Errado</label>
                          </div>
                        </div>
                        <div class="col-md-9">
                          <label for="feedback_{{ item.questao.id }}" class="form-label">Feedback (opcional):</label>
                          <input type="text" name="feedback_{{ item.questao.id }}" id="feedback_{{ item.questao.id }}" class="form-control" placeholder="Ex: A resposta correta era 'goes'">
                        </div>
                      {% endif %}
                    </div>

                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="d-flex justify-content-end gap-2 mt-4">
        <a href="{% url 'cadastros:lista_acompanhamento_pedagogico' %}" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-success btn-lg">Finalizar Correção</button>
      </div>
    </form>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // Função para sincronizar o editor com o input escondido
        function syncHiddenInput(editor) {
            const hiddenInputId = 'hidden-' + editor.id;
            const hiddenInput = document.getElementById(hiddenInputId);
            if (hiddenInput) {
                hiddenInput.value = editor.innerHTML;
            }
        }

        // 1. Sincroniza os 'div' editáveis com os 'input' escondidos
        const editores = document.querySelectorAll('.editor-corrigir');
        editores.forEach(editor => {
            // Sincronização inicial
            syncHiddenInput(editor);
            // Sincronização a cada mudança
            editor.addEventListener('input', () => syncHiddenInput(editor));
        });

        // 2. Ação do botão "Grifar em Vermelho"
        const botoesGrifar = document.querySelectorAll('.btn-grifar');
        botoesGrifar.forEach(botao => {
            botao.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Impede que o botão "roube" o foco
                const targetEditorId = botao.dataset.target;
                const editor = document.getElementById(targetEditorId);
                editor.focus(); 
                
                const selection = window.getSelection();
                if (!selection.rangeCount) return;
                
                const range = selection.getRangeAt(0);
                if (!editor.contains(range.commonAncestorContainer)) return;

                // Cria o <span> vermelho
                const span = document.createElement('span');
                span.style.color = 'red';
                try {
                    // Envolve o conteúdo selecionado com o <span>
                    range.surroundContents(span);
                } catch (ex) {
                    // Fallback se 'surroundContents' falhar (ex: seleção parcial)
                    document.execCommand('foreColor', false, 'red');
                }
                syncHiddenInput(editor); // Sincroniza
                selection.removeAllRanges(); // Limpa a seleção
            });
        });

        // 3. Ação do botão "Tirar Grifo"
        const botoesUngrifar = document.querySelectorAll('.btn-ungrifar');
        botoesUngrifar.forEach(botao => {
            botao.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Impede que o botão "roube" o foco
                const targetEditorId = botao.dataset.target;
                const editor = document.getElementById(targetEditorId);
                editor.focus();

                const selection = window.getSelection();
                if (!selection.rangeCount) return;

                const range = selection.getRangeAt(0);
                if (!editor.contains(range.commonAncestorContainer)) return;

                // Encontra o 'span' vermelho mais próximo que contém a seleção
                let node = range.commonAncestorContainer;
                let parentSpan = node.nodeType === 3 ? node.parentNode : node; // Se for texto, pega o pai
                
                let foundSpan = false;
                while (parentSpan && parentSpan !== editor) {
                    if (parentSpan.tagName === 'SPAN' && parentSpan.style.color === 'red') {
                        // Encontrámos o span. Agora vamos "desembrulhá-lo".
                        const fragment = document.createDocumentFragment();
                        while (parentSpan.firstChild) {
                            fragment.appendChild(parentSpan.firstChild);
                        }
                        // Substitui o <span> pelo seu conteúdo (o texto)
                        parentSpan.parentNode.replaceChild(fragment, parentSpan);
                        
                        foundSpan = true;
                        break; // Sair após remover um grifo
                    }
                    parentSpan = parentSpan.parentNode; // Sobe na hierarquia
                }

                // Fallback: se a lógica acima falhar (ex: seleção muito complexa)
                if (!foundSpan) {
                    document.execCommand('removeFormat', false, null);
                }
                
                syncHiddenInput(editor); // Sincroniza
                selection.removeAllRanges(); // Limpa a seleção
            });
        });

    });
  </script>
  </body>
</html>