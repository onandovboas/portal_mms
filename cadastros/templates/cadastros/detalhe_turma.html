{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro – {{ turma.nome }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Work+Sans:wght@400;500&display=swap" rel="stylesheet">
  <link href="{% static 'cadastros/mms_style.css' %}" rel="stylesheet">
  {% if request.resolver_match.url_name == 'dashboard_admin' %}
      <link href="{% static 'cadastros/dashboard.css' %}" rel="stylesheet">
  {% endif %}
  <style>
    :root { --gap: 1rem; }
    .content-wrap { max-width: 1200px; }
    .sticky-top-blur { position: sticky; top: 0; z-index: 1030; backdrop-filter: saturate(180%) blur(8px); background-color: rgba(255,255,255,.8); border-bottom: 1px solid rgba(0,0,0,.05); }
    @media (max-width: 576px) { .fab-bar { position: sticky; bottom: 0; z-index: 1020; box-shadow: 0 -6px 16px rgba(0,0,0,.1); } }
    .touch-target input[type="checkbox"] { inline-size: 1.2rem; block-size: 1.2rem; }
    .list-scroll { max-height: 260px; overflow: auto; }
    .muted-badge { background: #f8f9fa; color: #343a40; border: 1px solid #e9ecef; }
    #modalAulaAtrasada .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
  </style>
</head>
<body class="bg-light">
  <header class="sticky-top-blur">
    <nav class="navbar container content-wrap py-2" aria-label="Navegação da turma">
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'cadastros:portal_professor' %}" aria-label="Voltar para a lista de turmas">&larr; Voltar</a>
        <span class="vr mx-1"></span>
        <div class="d-flex flex-column">
          <strong class="lh-1">{{ turma.nome }}</strong>
          <small class="text-muted">Registro e histórico de aulas</small>
        </div>
      </div>
      <a href="{% url 'cadastros:liberar_prova_turma' turma.pk %}" class="btn btn-primary btn-sm">
        <i class="bi bi-send-check me-1"></i> Liberar Prova para Turma
      </a>
    </nav>
  </header>

  <main class="container content-wrap my-3">
    <section class="card mb-3" aria-labelledby="sec-detalhes">
      <div class="card-body">
        <h2 id="sec-detalhes" class="h5 mb-3">Detalhes da turma</h2>
        <form method="post" class="row gy-3 gx-3 align-items-end" novalidate>
          {% csrf_token %}
          <div class="col-12 col-md-6"><label for="nome_turma" class="form-label">Nome da Turma</label><input type="text" class="form-control form-control" name="nome_turma" id="nome_turma" value="{{ turma.nome }}" autocomplete="off" /></div>
          <div class="col-6 col-md-3"><label for="stage_turma" class="form-label">Stage</label><input type="number" inputmode="numeric" class="form-control" name="stage_turma" id="stage_turma" value="{{ turma.stage }}" /></div>
          <div class="col-6 col-md-3 d-grid"><button type="submit" name="salvar_detalhes_turma" class="btn btn-secondary">Salvar detalhes</button></div>
        </form>
      </div>
    </section>
    
    <section class="card mb-3">
      <div class="card-header"><h2 class="h5 mb-0">Avaliações da Turma</h2></div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Aluno</th><th>Prova</th><th>Status</th><th>Nota</th><th class="text-end">Ação</th>
            </tr>
          </thead>
          <tbody>
            {% for prova in provas_da_turma %}
              <tr>
                <td>{{ prova.aluno.nome_completo }}</td>
                <td>{{ prova.prova_template.titulo }}</td>
                <td><span class="badge ...">{{ prova.get_status_display }}</span></td>
                <td>
                  {% if prova.status == 'finalizada' %}
                    {{ prova.nota_final|floatformat:2 }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end">
                  {% if prova.status == 'aguardando_correcao' %}
                    <a href="{% url 'cadastros:corrigir_prova' prova.pk %}" class="btn btn-warning btn-sm">Corrigir</a>
                  {% elif prova.status == 'finalizada' %}
                    <a href="{% url 'cadastros:ver_resultado_prova' prova.pk %}" class="btn btn-info btn-sm">Ver Resultado</a>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-center text-muted p-3">Nenhuma avaliação liberada para esta turma.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="card mb-3" aria-labelledby="sec-historico">
      <div class="card-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <div>
          <h2 id="sec-historico" class="h5 mb-0">Visão Mensal da Turma</h2>
          <small class="text-muted">{{ data_selecionada|date:"F Y" }}</small>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#modalAulaAtrasada">
            <i class="bi bi-calendar-plus me-1"></i> Registrar Aula Atrasada
          </button>
          <div class="btn-group btn-group-sm" role="group" aria-label="Navegar por mês">
            <a href="{% url 'cadastros:detalhe_turma' pk=turma.pk %}?ano={{ nav.ano_anterior }}&mes={{ nav.mes_anterior }}" class="btn btn-outline-secondary" aria-label="Mês anterior">&larr;</a>
            <a href="{% url 'cadastros:detalhe_turma' pk=turma.pk %}?ano={{ nav.ano_seguinte }}&mes={{ nav.mes_seguinte }}" class="btn btn-outline-secondary" aria-label="Próximo mês">&rarr;</a>
          </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover small align-middle text-center">
            <thead class="table-light">
              <tr>
                <th scope="col" class="text-start">Data</th>
                <th scope="col" class="text-start">Professor</th>
                <th scope="col">Last Word</th>
                <th scope="col">Last Page Number</th>
                <th scope="col">Dictation (New/Old)</th>
                <th scope="col">Reading (New/Old)</th>
                <th scope="col">Lesson Check</th>
                <th scope="col" style="width: 1%;">Presença</th>
              </tr>
            </thead>
            <tbody>
              {% for aula in aulas_do_mes %}
                <tr>
                  <td class="text-nowrap text-start">
                    <a href="{% url 'cadastros:editar_registro_aula' aula.pk %}" class="fw-bold text-decoration-none d-inline-flex align-items-center gap-2">
                      <i class="bi bi-pencil-square"></i> {{ aula.data_aula|date:"d/m" }}
                    </a>
                  </td>
                  <td class="text-nowrap text-start">{{ aula.professor.nome_completo|default:"-" }}</td>
                  <td>{{ aula.last_word|default:"-" }}</td>
                  <td>{{ aula.last_parag|default:"-" }}</td>
                  <td>{{ aula.new_dictation|default:"-" }}/{{ aula.old_dictation|default:"-" }}</td>
                  <td>{{ aula.new_reading|default:"-" }}/{{ aula.old_reading|default:"-" }}</td>
                  <td>{{ aula.lesson_check|default:"-" }}</td>
                  <td>
                    {% if aula.alunos_ausentes %}
                      <div class="accordion accordion-flush" id="accordion-aula-{{ aula.pk }}">
                        <div class="accordion-item">
                          <h3 class="accordion-header m-0">
                            <button class="accordion-button collapsed p-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-aula-{{ aula.pk }}" aria-expanded="false" aria-controls="collapse-aula-{{ aula.pk }}">
                              <span class="badge bg-warning text-dark">{{ aula.alunos_ausentes|length }} Ausente(s)</span>
                            </button>
                          </h3>
                          <div id="collapse-aula-{{ aula.pk }}" class="accordion-collapse collapse" data-bs-parent="#accordion-aula-{{ aula.pk }}">
                            <div class="accordion-body p-2">
                              <ul class="list-unstyled mb-0">
                                {% for nome_aluno in aula.alunos_ausentes %}
                                  <li>{{ nome_aluno }}</li>
                                {% endfor %}
                              </ul>
                            </div>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> Todos presentes</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">Nenhum registro de aula encontrado para este mês.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        </div>
    </section>

    <div class="row g-3">
      <div class="col-12 col-lg-7">
        <section class="card" aria-labelledby="sec-registrar">
          <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h2 id="sec-registrar" class="h5 mb-0">
              Registrar Aula de Hoje
            </h2>
            {% if plano_de_hoje %}
              <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i> Pré-preenchido com o plano do dia</span>
            {% endif %}
          </div>
          <div class="card-body">
            <form method="post" novalidate id="form-aula-hoje">
              {% csrf_token %}
              
              <fieldset class="mb-3" aria-describedby="hint-presenca">
                <legend class="h6 mb-2">Lista de presença</legend>
                <p id="hint-presenca" class="text-muted small mb-2">Use a busca para filtrar alunos. "Marcar todos" afeta apenas a lista visível.</p>
                <div class="input-group mb-3" role="search"><span class="input-group-text" id="addon-search" aria-hidden="true"><i class="bi bi-search"></i></span><input type="search" class="form-control" id="filtro-alunos" placeholder="Buscar aluno pelo nome" aria-label="Buscar aluno pelo nome" aria-describedby="addon-search" /><button type="button" class="btn btn-outline-secondary" id="btn-limpar-filtro" aria-label="Limpar busca">Limpar</button></div>
                <div class="accordion" id="accordionPresenca">
                  <div class="accordion-item"><h3 class="accordion-header" id="head-matriculados"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-matriculados" aria-expanded="true" aria-controls="collapse-matriculados">Matriculados <span class="badge bg-secondary ms-2" id="count-matriculados">{{ matriculados.count }}</span></button></h3><div id="collapse-matriculados" class="accordion-collapse collapse show" aria-labelledby="head-matriculados" data-bs-parent="#accordionPresenca"><div class="accordion-body"><div class="d-flex justify-content-between align-items-center mb-2"><div class="form-check touch-target"><input class="form-check-input" type="checkbox" id="toggle-all-matriculados" /><label class="form-check-label" for="toggle-all-matriculados">Marcar todos visíveis</label></div><small class="text-muted" id="sel-matriculados" aria-live="polite"></small></div><ul class="list-unstyled list-scroll" id="lista-matriculados">{% for inscricao in matriculados %}<li class="mb-1 aluno-item" data-nome="{{ inscricao.aluno.nome_completo|lower }}"><div class="form-check touch-target"><input class="form-check-input presenca-checkbox" type="checkbox" name="presenca" value="{{ inscricao.aluno.pk }}" id="m-{{ inscricao.aluno.pk }}" /><label class="form-check-label" for="m-{{ inscricao.aluno.pk }}">{{ inscricao.aluno.nome_completo }}</label></div></li>{% empty %}<li class="text-muted">Nenhum aluno matriculado nesta turma.</li>{% endfor %}</ul></div></div></div>
                  <div class="accordion-item"><h3 class="accordion-header" id="head-experimentais"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-experimentais" aria-expanded="false" aria-controls="collapse-experimentais">Aula Experimental <span class="badge bg-info text-dark ms-2">{{ experimentais.count }}</span></button></h3><div id="collapse-experimentais" class="accordion-collapse collapse" aria-labelledby="head-experimentais" data-bs-parent="#accordionPresenca"><div class="accordion-body"><div class="d-flex justify-content-between align-items-center mb-2"><div class="form-check touch-target"><input class="form-check-input" type="checkbox" id="toggle-all-experimentais" /><label class="form-check-label" for="toggle-all-experimentais">Marcar todos visíveis</label></div><small class="text-muted" id="sel-experimentais" aria-live="polite"></small></div><ul class="list-unstyled list-scroll" id="lista-experimentais">{% for inscricao in experimentais %}<li class="mb-1 aluno-item" data-nome="{{ inscricao.aluno.nome_completo|lower }}"><div class="form-check touch-target"><input class="form-check-input presenca-checkbox" type="checkbox" name="presenca" value="{{ inscricao.aluno.pk }}" id="e-{{ inscricao.aluno.pk }}" /><label class="form-check-label" for="e-{{ inscricao.aluno.pk }}">{{ inscricao.aluno.nome_completo }}</label></div></li>{% empty %}<li class="text-muted">Nenhum aluno em aula experimental nesta turma.</li>{% endfor %}</ul></div></div></div>
                  <div class="accordion-item"><h3 class="accordion-header" id="head-acompanhando"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-acompanhando" aria-expanded="false" aria-controls="collapse-acompanhando">Acompanhando <span class="badge muted-badge ms-2">{{ acompanhando.count }}</span></button></h3><div id="collapse-acompanhando" class="accordion-collapse collapse" aria-labelledby="head-acompanhando" data-bs-parent="#accordionPresenca"><div class="accordion-body"><div class="d-flex justify-content-between align-items-center mb-2"><div class="form-check touch-target"><input class="form-check-input" type="checkbox" id="toggle-all-acompanhando" /><label class="form-check-label" for="toggle-all-acompanhando">Marcar todos visíveis</label></div><small class="text-muted" id="sel-acompanhando" aria-live="polite"></small></div><ul class="list-unstyled list-scroll" id="lista-acompanhando">{% for inscricao in acompanhando %}<li class="mb-1 aluno-item" data-nome="{{ inscricao.aluno.nome_completo|lower }}"><div class="form-check touch-target"><input class="form-check-input presenca-checkbox" type="checkbox" name="presenca" value="{{ inscricao.aluno.pk }}" id="a-{{ inscricao.aluno.pk }}" /><label class="form-check-label" for="a-{{ inscricao.aluno.pk }}">{{ inscricao.aluno.nome_completo }}</label></div></li>{% empty %}<li class="text-muted">Nenhum aluno acompanhando esta turma.</li>{% endfor %}</ul></div></div></div>
                  <div class="accordion-item"><h3 class="accordion-header" id="head-trancados"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-trancados" aria-expanded="false" aria-controls="collapse-trancados">Trancados <span class="badge bg-danger ms-2">{{ trancados.count }}</span></button></h3><div id="collapse-trancados" class="accordion-collapse collapse" aria-labelledby="head-trancados" data-bs-parent="#accordionPresenca"><div class="accordion-body"><ul class="list-unstyled mb-0">{% for inscricao in trancados %}<li class="text-muted">{{ inscricao.aluno.nome_completo }}</li>{% empty %}<li class="text-muted">Nenhum aluno com matrícula trancada nesta turma.</li>{% endfor %}</ul></div></div></div>
                </div>
              </fieldset>
              
              <hr class="my-4" />
              
              <fieldset aria-labelledby="legend-licao" class="gy-3 row">
                <legend id="legend-licao" class="h6">Detalhes da lição</legend>
                <div class="col-md-6"><label class="form-label" for="last_word">Last Word</label><input type="text" name="last_word" id="last_word" class="form-control" autocomplete="off" value="{{ plano_de_hoje.last_word|default:'' }}" data-unsaved-check /></div>
                <div class="col-md-6"><label class="form-label" for="last_parag">Last Page Number</label><input type="number" name="last_parag" id="last_parag" class="form-control" inputmode="numeric" value="{{ plano_de_hoje.last_parag|default:'' }}" data-unsaved-check /></div>
                <div class="col-md-6"><label class="form-label" for="new_dictation">New Dictation (nº)</label><input type="text" name="new_dictation" id="new_dictation" class="form-control" autocomplete="off" value="{{ plano_de_hoje.new_dictation|default:'' }}" data-unsaved-check /></div>
                <div class="col-md-6"><label class="form-label" for="old_dictation">Old Dictation (nº)</label><input type="text" name="old_dictation" id="old_dictation" class="form-control" autocomplete="off" value="{{ plano_de_hoje.old_dictation|default:'' }}" data-unsaved-check /></div>
                <div class="col-md-6"><label class="form-label" for="new_reading">New Reading (nº)</label><input type="text" name="new_reading" id="new_reading" class="form-control" autocomplete="off" value="{{ plano_de_hoje.new_reading|default:'' }}" data-unsaved-check /></div>
                <div class="col-md-6"><label class="form-label" for="old_reading">Old Reading (nº)</label><input type="text" name="old_reading" id="old_reading" class="form-control" autocomplete="off" value="{{ plano_de_hoje.old_reading|default:'' }}" data-unsaved-check /></div>
                <div class="col-12"><label class="form-label" for="lesson_check">Lesson Check</label><input type="text" name="lesson_check" id="lesson_check" class="form-control" autocomplete="off" value="{{ plano_de_hoje.lesson_check|default:'' }}" data-unsaved-check /></div>
              </fieldset>
              
              <div class="fab-bar bg-white p-2 mt-3 rounded-3 d-grid"><button type="submit" name="salvar_aula" class="btn btn-primary btn-lg">Salvar registro da aula</button></div>
            </form>
          </div>
        </section>
      </div>

      <div class="col-12 col-lg-5">
        <section class="card mb-3" aria-labelledby="sec-faltas">
          <div class="card-header"><h2 id="sec-faltas" class="h5 mb-0">Faltas no Mês</h2></div>
          <div class="card-body">
            {% if faltas_do_mes %}
              <ul class="list-group list-group-flush">
                {% for falta in faltas_do_mes %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ falta.aluno__nome_completo }}
                    <span class="badge bg-danger rounded-pill">{{ falta.total_faltas }}</span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted text-center mb-0">Nenhuma falta registrada neste mês. Ótimo trabalho!</p>
            {% endif %}
          </div>
        </section>

        <section class="card" aria-labelledby="sec-anotacoes">
          <div class="card-header"><h2 id="sec-anotacoes" class="h5 mb-0">Anotações importantes</h2></div>
          <div class="card-body">
            <form method="post" novalidate>{% csrf_token %}<div class="mb-2"><label for="anotacoes_gerais" class="form-label visually-hidden">Anotações da turma</label><textarea id="anotacoes_gerais" name="anotacoes_gerais" class="form-control" rows="4" placeholder="Ex.: conteúdos-chave, dificuldades coletivas, combinados de sala">{{ turma.anotacoes_gerais|default:"" }}</textarea></div><button type="submit" name="salvar_anotacoes" class="btn btn-secondary btn-sm">Salvar anotações</button></form>
          </div>
        </section>
      </div>
    </div>
  </main>

  <div class="modal fade" id="modalAulaAtrasada" tabindex="-1" aria-labelledby="modalAulaAtrasadaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form method="post" novalidate>
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="modalAulaAtrasadaLabel">Registrar Aula Atrasada</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            
            <fieldset class="gy-3 row mb-3">
              <legend class="h6">Dados da Aula</legend>
              <div class="col-12 col-md-6">
                <label for="data_aula_atrasada" class="form-label">Data da Aula <span class="text-danger">*</span></label>
                <input type="date" name="data_aula_atrasada" id="data_aula_atrasada" class="form-control" required>
              </div>
              <div class="col-12 col-md-6">
                <label for="professor_aula_atrasada" class="form-label">Professor que ministrou <span class="text-danger">*</span></label>
                <select name="professor_aula_atrasada" id="professor_aula_atrasada" class="form-select" required>
                  <option value="">Selecione um professor...</option>
                  {% for prof in todos_professores %}
                    <option value="{{ prof.pk }}" {% if user.professor == prof %}selected{% endif %}>
                      {{ prof.nome_completo }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </fieldset>

            <hr class="my-4">

            <fieldset class="mb-3">
              <legend class="h6 mb-2">Lista de presença</legend>
              <div class="accordion" id="accordionPresencaAtrasada">
                
                <div class="accordion-item">
                  <h3 class="accordion-header" id="head-matriculados-atrasada"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-matriculados-atrasada" aria-expanded="true" aria-controls="collapse-matriculados-atrasada">Matriculados <span class="badge bg-secondary ms-2">{{ matriculados.count }}</span></button></h3>
                  <div id="collapse-matriculados-atrasada" class="accordion-collapse collapse show" aria-labelledby="head-matriculados-atrasada" data-bs-parent="#accordionPresencaAtrasada">
                    <div class="accordion-body">
                      <ul class="list-unstyled list-scroll" id="lista-matriculados-atrasada">
                        {% for inscricao in matriculados %}<li class="mb-1"><div class="form-check touch-target"><input class="form-check-input" type="checkbox" name="presenca_atrasada" value="{{ inscricao.aluno.pk }}" id="m-atrasada-{{ inscricao.aluno.pk }}" /><label class="form-check-label" for="m-atrasada-{{ inscricao.aluno.pk }}">{{ inscricao.aluno.nome_completo }}</label></div></li>{% empty %}<li class="text-muted">Nenhum aluno matriculado.</li>{% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h3 class="accordion-header" id="head-experimentais-atrasada"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-experimentais-atrasada" aria-expanded="false" aria-controls="collapse-experimentais-atrasada">Aula Experimental <span class="badge bg-info text-dark ms-2">{{ experimentais.count }}</span></button></h3>
                  <div id="collapse-experimentais-atrasada" class="accordion-collapse collapse" aria-labelledby="head-experimentais-atrasada" data-bs-parent="#accordionPresencaAtrasada">
                    <div class="accordion-body">
                      <ul class="list-unstyled list-scroll" id="lista-experimentais-atrasada">
                        {% for inscricao in experimentais %}<li class="mb-1"><div class="form-check touch-target"><input class="form-check-input" type="checkbox" name="presenca_atrasada" value="{{ inscricao.aluno.pk }}" id="e-atrasada-{{ inscricao.aluno.pk }}" /><label class="form-check-label" for="e-atrasada-{{ inscricao.aluno.pk }}">{{ inscricao.aluno.nome_completo }}</label></div></li>{% empty %}<li class="text-muted">Nenhum aluno experimental.</li>{% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h3 class="accordion-header" id="head-acompanhando-atrasada"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-acompanhando-atrasada" aria-expanded="false" aria-controls="collapse-acompanhando-atrasada">Acompanhando <span class="badge muted-badge ms-2">{{ acompanhando.count }}</span></button></h3>
                  <div id="collapse-acompanhando-atrasada" class="accordion-collapse collapse" aria-labelledby="head-acompanhando-atrasada" data-bs-parent="#accordionPresencaAtrasada">
                    <div class="accordion-body">
                      <ul class="list-unstyled list-scroll" id="lista-acompanhando-atrasada">
                        {% for inscricao in acompanhando %}<li class="mb-1"><div class="form-check touch-target"><input class="form-check-input" type="checkbox" name="presenca_atrasada" value="{{ inscricao.aluno.pk }}" id="a-atrasada-{{ inscricao.aluno.pk }}" /><label class="form-check-label" for="a-atrasada-{{ inscricao.aluno.pk }}">{{ inscricao.aluno.nome_completo }}</label></div></li>{% empty %}<li class="text-muted">Nenhum aluno acompanhando.</li>{% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>

              </div>
            </fieldset>

            <hr class="my-4">

            <fieldset aria-labelledby="legend-licao-atrasada" class="gy-3 row">
              <legend id="legend-licao-atrasada" class="h6">Detalhes da lição</legend>
              <div class="col-md-6"><label class="form-label" for="last_word_atrasada">Last Word</label><input type="text" name="last_word_atrasada" id="last_word_atrasada" class="form-control" autocomplete="off" /></div>
              <div class="col-md-6"><label class="form-label" for="last_parag_atrasada">Last Page Number</label><input type="number" name="last_parag_atrasada" id="last_parag_atrasada" class="form-control" inputmode="numeric" /></div>
              <div class="col-md-6"><label class="form-label" for="new_dictation_atrasada">Dictation New (nº)</label><input type="number" name="new_dictation_atrasada" id="new_dictation_atrasada" class="form-control" inputmode="numeric" /></div>
              <div class="col-md-6"><label class="form-label" for="old_dictation_atrasada">Dictation Old (nº)</label><input type="number" name="old_dictation_atrasada" id="old_dictation_atrasada" class="form-control" inputmode="numeric" /></div>
              <div class="col-md-6"><label class="form-label" for="new_reading_atrasada">Reading New (nº)</label><input type="number" name="new_reading_atrasada" id="new_reading_atrasada" class="form-control" inputmode="numeric" /></div>
              <div class="col-md-6"><label class="form-label" for="old_reading_atrasada">Reading Old (nº)</label><input type="number" name="old_reading_atrasada" id="old_reading_atrasada" class="form-control" inputmode="numeric" /></div>
              <div class="col-12"><label class="form-label" for="lesson_check_atrasada">Lesson Check</label><input type="text" name="lesson_check_atrasada" id="lesson_check_atrasada" class="form-control" autocomplete="off" /></div>
            </fieldset>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" name="salvar_aula_atrasada" class="btn btn-primary">Salvar registro da aula</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- Filtro de alunos e seleção em massa ---
    (function(){
      const filtro = document.getElementById('filtro-alunos');
      const limpar = document.getElementById('btn-limpar-filtro');
      const grupos = [
        { list: document.getElementById('lista-matriculados'), toggle: document.getElementById('toggle-all-matriculados'), sel: document.getElementById('sel-matriculados') },
        { list: document.getElementById('lista-experimentais'), toggle: document.getElementById('toggle-all-experimentais'), sel: document.getElementById('sel-experimentais') },
        { list: document.getElementById('lista-acompanhando'), toggle: document.getElementById('toggle-all-acompanhando'), sel: document.getElementById('sel-acompanhando') },
      ].filter(g => g.list);

      function aplicaFiltro() {
        const q = (filtro?.value || '').trim().toLowerCase();
        grupos.forEach(g => {
          let visiveis = 0, marcados = 0;
          g.list.querySelectorAll('.aluno-item').forEach(li => {
            const nome = li.getAttribute('data-nome') || '';
            const show = !q || nome.includes(q);
            li.style.display = show ? '' : 'none';
            if (show) {
              visiveis++;
              const cb = li.querySelector('input[type="checkbox"]');
              if (cb && cb.checked) marcados++;
            }
          });
          if (g.sel) {
            g.sel.textContent = visiveis ? `${marcados}/${visiveis} selecionados` : '';
          }
        });
      }

      filtro?.addEventListener('input', aplicaFiltro);
      limpar?.addEventListener('click', () => { if (!filtro) return; filtro.value = ''; filtro.focus(); aplicaFiltro(); });

      grupos.forEach(g => {
        g.toggle?.addEventListener('change', () => {
          const q = (filtro?.value || '').trim().toLowerCase();
          g.list.querySelectorAll('.aluno-item').forEach(li => {
            const nome = li.getAttribute('data-nome') || '';
            const visible = !q || nome.includes(q);
            if (!visible) return;
            const cb = li.querySelector('input[type="checkbox"]');
            if (cb) cb.checked = g.toggle.checked;
          });
          aplicaFiltro();
        });
      });

      document.addEventListener('change', (e) => {
        if (e.target.classList?.contains('presenca-checkbox')) aplicaFiltro();
      });

      aplicaFiltro();
    })();
  </script>
</body>
</html>