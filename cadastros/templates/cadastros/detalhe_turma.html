<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro – {{ turma.nome }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --gap: 1rem;
    }
    .content-wrap { max-width: 1200px; }
    .sticky-top-blur {
      position: sticky; top: 0; z-index: 1030; backdrop-filter: saturate(180%) blur(8px);
      background-color: rgba(255,255,255,.8); border-bottom: 1px solid rgba(0,0,0,.05);
    }
    @media (max-width: 576px) {
      .fab-bar { position: sticky; bottom: 0; z-index: 1020; box-shadow: 0 -6px 16px rgba(0,0,0,.1); }
    }
    .touch-target input[type="checkbox"] { inline-size: 1.2rem; block-size: 1.2rem; }
    .list-scroll { max-height: 260px; overflow: auto; }
    .muted-badge { background: #f8f9fa; color: #343a40; border: 1px solid #e9ecef; }
  </style>
</head>
<body class="bg-light">
  <!-- Cabeçalho / Navegação -->
  <header class="sticky-top-blur">
    <nav class="navbar container content-wrap py-2" aria-label="Navegação da turma">
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'cadastros:portal_professor' %}" aria-label="Voltar para a lista de turmas">
          &larr; Voltar
        </a>
        <span class="vr mx-1"></span>
        <div class="d-flex flex-column">
          <strong class="lh-1">{{ turma.nome }}</strong>
          <small class="text-muted">Registro e histórico de aulas</small>
        </div>
      </div>
    </nav>
  </header>

  <main class="container content-wrap my-3">
    <!-- Edição rápida da turma -->
    <section class="card mb-3" aria-labelledby="sec-detalhes">
      <div class="card-body">
        <h2 id="sec-detalhes" class="h5 mb-3">Detalhes da turma</h2>
        <form method="post" class="row gy-3 gx-3 align-items-end" novalidate>
          {% csrf_token %}
          <div class="col-12 col-md-6">
            <label for="nome_turma" class="form-label">Nome da Turma</label>
            <input type="text" class="form-control form-control" name="nome_turma" id="nome_turma" value="{{ turma.nome }}" autocomplete="off" />
          </div>
          <div class="col-6 col-md-3">
            <label for="stage_turma" class="form-label">Stage</label>
            <input type="number" inputmode="numeric" class="form-control" name="stage_turma" id="stage_turma" value="{{ turma.stage }}" />
          </div>
          <div class="col-6 col-md-3 d-grid">
            <button type="submit" name="salvar_detalhes_turma" class="btn btn-secondary">Salvar detalhes</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Grid principal: esquerda registro / direita histórico + anotações -->
    <div class="row g-3">
      <div class="col-12 col-lg-7 order-2 order-lg-1">
        <!-- Registrar Nova Aula -->
        <section class="card" aria-labelledby="sec-registrar">
          <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h2 id="sec-registrar" class="h5 mb-0">Registrar nova aula</h2>
            <small class="text-muted">Preencha presença e detalhes da lição</small>
          </div>
          <div class="card-body">
            <form method="post" novalidate>
              {% csrf_token %}

              <!-- Lista de Presença -->
              <fieldset class="mb-3" aria-describedby="hint-presenca">
                <legend class="h6 mb-2">Lista de presença</legend>
                <p id="hint-presenca" class="text-muted small mb-2">Use a busca para filtrar alunos. "Marcar todos" afeta apenas a lista visível.</p>

                <div class="input-group mb-3" role="search">
                  <span class="input-group-text" id="addon-search" aria-hidden="true"><i class="bi bi-search"></i></span>
                  <input type="search" class="form-control" id="filtro-alunos" placeholder="Buscar aluno pelo nome" aria-label="Buscar aluno pelo nome" aria-describedby="addon-search" />
                  <button type="button" class="btn btn-outline-secondary" id="btn-limpar-filtro" aria-label="Limpar busca">Limpar</button>
                </div>

                <!-- O SEU ACORDEÃO DE PRESENÇA COMPLETO -->
                <div class="accordion" id="accordionPresenca">
                  <!-- Matriculados -->
                  <div class="accordion-item">
                    <h3 class="accordion-header" id="head-matriculados">
                      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-matriculados" aria-expanded="true" aria-controls="collapse-matriculados">
                        Matriculados <span class="badge bg-secondary ms-2" id="count-matriculados">{{ matriculados.count }}</span>
                      </button>
                    </h3>
                    <div id="collapse-matriculados" class="accordion-collapse collapse show" aria-labelledby="head-matriculados" data-bs-parent="#accordionPresenca">
                      <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <div class="form-check touch-target">
                            <input class="form-check-input" type="checkbox" id="toggle-all-matriculados" />
                            <label class="form-check-label" for="toggle-all-matriculados">Marcar todos visíveis</label>
                          </div>
                          <small class="text-muted" id="sel-matriculados" aria-live="polite"></small>
                        </div>
                        <ul class="list-unstyled list-scroll" id="lista-matriculados">
                          {% for inscricao in matriculados %}
                            <li class="mb-1 aluno-item" data-nome="{{ inscricao.aluno.nome_completo|lower }}">
                              <div class="form-check touch-target">
                                <input class="form-check-input presenca-checkbox" type="checkbox" name="presenca" value="{{ inscricao.aluno.pk }}" id="m-{{ inscricao.aluno.pk }}" />
                                <label class="form-check-label" for="m-{{ inscricao.aluno.pk }}">{{ inscricao.aluno.nome_completo }}</label>
                              </div>
                            </li>
                          {% empty %}
                            <li class="text-muted">Nenhum aluno matriculado nesta turma.</li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>
                  </div>

                  <!-- Experimentais -->
                  <div class="accordion-item">
                    <h3 class="accordion-header" id="head-experimentais">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-experimentais" aria-expanded="false" aria-controls="collapse-experimentais">
                        Aula Experimental <span class="badge bg-info text-dark ms-2">{{ experimentais.count }}</span>
                      </button>
                    </h3>
                    <div id="collapse-experimentais" class="accordion-collapse collapse" aria-labelledby="head-experimentais" data-bs-parent="#accordionPresenca">
                      <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <div class="form-check touch-target">
                            <input class="form-check-input" type="checkbox" id="toggle-all-experimentais" />
                            <label class="form-check-label" for="toggle-all-experimentais">Marcar todos visíveis</label>
                          </div>
                          <small class="text-muted" id="sel-experimentais" aria-live="polite"></small>
                        </div>
                        <ul class="list-unstyled list-scroll" id="lista-experimentais">
                          {% for inscricao in experimentais %}
                            <li class="mb-1 aluno-item" data-nome="{{ inscricao.aluno.nome_completo|lower }}">
                              <div class="form-check touch-target">
                                <input class="form-check-input presenca-checkbox" type="checkbox" name="presenca" value="{{ inscricao.aluno.pk }}" id="e-{{ inscricao.aluno.pk }}" />
                                <label class="form-check-label" for="e-{{ inscricao.aluno.pk }}">{{ inscricao.aluno.nome_completo }}</label>
                              </div>
                            </li>
                          {% empty %}
                            <li class="text-muted">Nenhum aluno em aula experimental nesta turma.</li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>
                  </div>

                  <!-- Acompanhando -->
                  <div class="accordion-item">
                    <h3 class="accordion-header" id="head-acompanhando">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-acompanhando" aria-expanded="false" aria-controls="collapse-acompanhando">
                        Acompanhando <span class="badge muted-badge ms-2">{{ acompanhando.count }}</span>
                      </button>
                    </h3>
                    <div id="collapse-acompanhando" class="accordion-collapse collapse" aria-labelledby="head-acompanhando" data-bs-parent="#accordionPresenca">
                      <div class="accordion-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <div class="form-check touch-target">
                            <input class="form-check-input" type="checkbox" id="toggle-all-acompanhando" />
                            <label class="form-check-label" for="toggle-all-acompanhando">Marcar todos visíveis</label>
                          </div>
                          <small class="text-muted" id="sel-acompanhando" aria-live="polite"></small>
                        </div>
                        <ul class="list-unstyled list-scroll" id="lista-acompanhando">
                          {% for inscricao in acompanhando %}
                            <li class="mb-1 aluno-item" data-nome="{{ inscricao.aluno.nome_completo|lower }}">
                              <div class="form-check touch-target">
                                <input class="form-check-input presenca-checkbox" type="checkbox" name="presenca" value="{{ inscricao.aluno.pk }}" id="a-{{ inscricao.aluno.pk }}" />
                                <label class="form-check-label" for="a-{{ inscricao.aluno.pk }}">{{ inscricao.aluno.nome_completo }}</label>
                              </div>
                            </li>
                          {% empty %}
                            <li class="text-muted">Nenhum aluno acompanhando esta turma.</li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>
                  </div>

                  <!-- Trancados (só leitura) -->
                  <div class="accordion-item">
                    <h3 class="accordion-header" id="head-trancados">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-trancados" aria-expanded="false" aria-controls="collapse-trancados">
                        Trancados <span class="badge bg-danger ms-2">{{ trancados.count }}</span>
                      </button>
                    </h3>
                    <div id="collapse-trancados" class="accordion-collapse collapse" aria-labelledby="head-trancados" data-bs-parent="#accordionPresenca">
                      <div class="accordion-body">
                        <ul class="list-unstyled mb-0">
                          {% for inscricao in trancados %}
                            <li class="text-muted">{{ inscricao.aluno.nome_completo }}</li>
                          {% empty %}
                            <li class="text-muted">Nenhum aluno com matrícula trancada nesta turma.</li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>

              </fieldset>

              <hr class="my-4" />

              <!-- Detalhes da Lição -->
              <fieldset aria-labelledby="legend-licao" class="gy-3 row">
                <legend id="legend-licao" class="h6">Detalhes da lição</legend>
                <div class="col-md-6">
                  <label class="form-label" for="last_word">Última palavra</label>
                  <input type="text" name="last_word" id="last_word" class="form-control" autocomplete="off" />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="last_parag">Último parágrafo</label>
                  <input type="number" name="last_parag" id="last_parag" class="form-control" inputmode="numeric" />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="new_dictation">Ditado novo (nº)</label>
                  <input type="number" name="new_dictation" id="new_dictation" class="form-control" inputmode="numeric" />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="old_dictation">Ditado antigo (nº)</label>
                  <input type="number" name="old_dictation" id="old_dictation" class="form-control" inputmode="numeric" />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="new_reading">Leitura nova (nº)</label>
                  <input type="number" name="new_reading" id="new_reading" class="form-control" inputmode="numeric" />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="old_reading">Leitura antiga (nº)</label>
                  <input type="number" name="old_reading" id="old_reading" class="form-control" inputmode="numeric" />
                </div>
                <div class="col-12">
                  <label class="form-label" for="lesson_check">Lesson Check</label>
                  <input type="text" name="lesson_check" id="lesson_check" class="form-control" autocomplete="off" />
                </div>
              </fieldset>

              <!-- Barra de ação -->
              <div class="fab-bar bg-white p-2 mt-3 rounded-3 d-grid">
                <button type="submit" name="salvar_aula" class="btn btn-primary btn-lg">Salvar registro da aula</button>
              </div>
            </form>
          </div>
        </section>
      </div>

      <div class="col-12 col-lg-5 order-1 order-lg-2">
        <!-- Histórico -->
        <section class="card mb-3" aria-labelledby="sec-historico">
          <div class="card-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
            <div>
              <h2 id="sec-historico" class="h5 mb-0">Histórico de aulas</h2>
              <small class="text-muted">{{ data_selecionada|date:"F Y" }}</small>
            </div>
            <div class="btn-group btn-group-sm" role="group" aria-label="Navegar por mês">
              <a href="{% url 'cadastros:detalhe_turma' pk=turma.pk %}?ano={{ nav.ano_anterior }}&mes={{ nav.mes_anterior }}" class="btn btn-outline-secondary" aria-label="Mês anterior">&larr;</a>
              <a href="{% url 'cadastros:detalhe_turma' pk=turma.pk %}?ano={{ nav.ano_seguinte }}&mes={{ nav.mes_seguinte }}" class="btn btn-outline-secondary" aria-label="Próximo mês">&rarr;</a>
            </div>
          </div>
          <div class="card-body">
            <!-- 👇 MUDANÇA 1: O loop agora usa 'page_obj' 👇 -->
            {% for aula in page_obj %}
              <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <strong class="d-block">Aula de {{ aula.data_aula|date:"d/m/Y" }}</strong>
                    <small class="text-muted">{{ aula.professor.nome_completo|default:"Professor não informado" }}</small>
                  </div>
                  <a href="{% url 'cadastros:editar_registro_aula' aula.pk %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-pencil-square"></i> Editar
                  </a>
                </div>
                <ul class="list-group list-group-flush small">
                  <li class="list-group-item"><strong>Última Palavra:</strong> {{ aula.last_word|default:"-" }}</li>
                  <li class="list-group-item"><strong>Últ. Parág.:</strong> {{ aula.last_parag|default:"-" }}</li>
                  <li class="list-group-item"><strong>Ditado (Novo/Antigo):</strong> {{ aula.new_dictation|default:"-" }}/{{ aula.old_dictation|default:"-" }}</li>
                  <li class="list-group-item"><strong>Leitura (Nova/Antiga):</strong> {{ aula.new_reading|default:"-" }}/{{ aula.old_reading|default:"-" }}</li>
                  <li class="list-group-item"><strong>Lesson Check:</strong> {{ aula.lesson_check|default:"-" }}</li>
                </ul>
              </div>
            {% empty %}
              <div class="text-center text-muted">Nenhum registro de aula encontrado para este mês.</div>
            {% endfor %}

            <!-- 👇 MUDANÇA 2: Os controlos de paginação foram adicionados aqui 👇 -->
            {% if page_obj.paginator.num_pages > 1 %}
            <nav aria-label="Navegação do histórico de aulas" class="mt-4">
              <ul class="pagination pagination-sm justify-content-center">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&ano={{ data_selecionada.year }}&mes={{ data_selecionada.month }}">&laquo;</a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                  {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                  {% else %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ num }}&ano={{ data_selecionada.year }}&mes={{ data_selecionada.month }}">{{ num }}</a>
                    </li>
                  {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&ano={{ data_selecionada.year }}&mes={{ data_selecionada.month }}">&raquo;</a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          </div>
        </section>

        <!-- Anotações -->
        <section class="card" aria-labelledby="sec-anotacoes">
          <div class="card-header"><h2 id="sec-anotacoes" class="h5 mb-0">Anotações importantes</h2></div>
          <div class="card-body">
            <form method="post" novalidate>
              {% csrf_token %}
              <div class="mb-2">
                <label for="anotacoes_gerais" class="form-label visually-hidden">Anotações da turma</label>
                <textarea id="anotacoes_gerais" name="anotacoes_gerais" class="form-control" rows="4" placeholder="Ex.: conteúdos-chave, dificuldades coletivas, combinados de sala">{{ turma.anotacoes_gerais|default:"" }}</textarea>
              </div>
              <button type="submit" name="salvar_anotacoes" class="btn btn-secondary btn-sm">Salvar anotações</button>
            </form>
          </div>
        </section>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- Filtro de alunos e seleção em massa ---
    (function(){
      const filtro = document.getElementById('filtro-alunos');
      const limpar = document.getElementById('btn-limpar-filtro');
      const grupos = [
        { list: document.getElementById('lista-matriculados'), toggle: document.getElementById('toggle-all-matriculados'), sel: document.getElementById('sel-matriculados') },
        { list: document.getElementById('lista-experimentais'), toggle: document.getElementById('toggle-all-experimentais'), sel: document.getElementById('sel-experimentais') },
        { list: document.getElementById('lista-acompanhando'), toggle: document.getElementById('toggle-all-acompanhando'), sel: document.getElementById('sel-acompanhando') },
      ].filter(g => g.list);

      function aplicaFiltro() {
        const q = (filtro?.value || '').trim().toLowerCase();
        grupos.forEach(g => {
          let visiveis = 0, marcados = 0;
          g.list.querySelectorAll('.aluno-item').forEach(li => {
            const nome = li.getAttribute('data-nome') || '';
            const show = !q || nome.includes(q);
            li.style.display = show ? '' : 'none';
            if (show) {
              visiveis++;
              const cb = li.querySelector('input[type="checkbox"]');
              if (cb && cb.checked) marcados++;
            }
          });
          if (g.sel) {
            g.sel.textContent = visiveis ? `${marcados}/${visiveis} selecionados` : '';
          }
        });
      }

      filtro?.addEventListener('input', aplicaFiltro);
      limpar?.addEventListener('click', () => { if (!filtro) return; filtro.value = ''; filtro.focus(); aplicaFiltro(); });

      grupos.forEach(g => {
        g.toggle?.addEventListener('change', () => {
          const q = (filtro?.value || '').trim().toLowerCase();
          g.list.querySelectorAll('.aluno-item').forEach(li => {
            const nome = li.getAttribute('data-nome') || '';
            const visible = !q || nome.includes(q);
            if (!visible) return;
            const cb = li.querySelector('input[type="checkbox"]');
            if (cb) cb.checked = g.toggle.checked;
          });
          aplicaFiltro();
        });
      });

      document.addEventListener('change', (e) => {
        if (e.target.classList?.contains('presenca-checkbox')) aplicaFiltro();
      });

      aplicaFiltro();
    })();
  </script>
</body>
</html>