{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de Marketing - MMS Portal</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
    .card-kpi { border: none; border-radius: 12px; transition: transform 0.2s; }
    .card-kpi:hover { transform: translateY(-5px); }
    .icon-box { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .chart-container { position: relative; height: 250px; width: 100%; }
    .card-chart { border: none; border-radius: 12px; height: 100%; }
    .card-header-chart { background-color: white; border-bottom: none; padding-top: 1.5rem; padding-left: 1.5rem; border-radius: 12px 12px 0 0; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><i class="bi bi-bar-chart-line-fill me-2"></i>MMS Marketing</a>
    <div class="d-flex">
      <a href="{% url 'cadastros:dashboard_admin' %}" class="btn btn-outline-light btn-sm">
        <i class="bi bi-arrow-left"></i> Voltar ao Painel
      </a>
    </div>
  </div>
</nav>

<div class="container pb-5">

  <div class="row g-4 mb-5">
    <div class="col-md-4">
      <div class="card card-kpi shadow-sm h-100">
        <div class="card-body d-flex align-items-center">
          <div class="icon-box bg-primary bg-opacity-10 text-primary me-3"><i class="bi bi-people-fill"></i></div>
          <div><h6 class="text-muted mb-0">Total de Leads</h6><h3 class="fw-bold mb-0">{{ leads_total }}</h3></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-kpi shadow-sm h-100">
        <div class="card-body d-flex align-items-center">
          <div class="icon-box bg-success bg-opacity-10 text-success me-3"><i class="bi bi-person-check-fill"></i></div>
          <div><h6 class="text-muted mb-0">Convertidos</h6><h3 class="fw-bold mb-0">{{ leads_convertidos }}</h3></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-kpi shadow-sm h-100">
        <div class="card-body d-flex align-items-center">
          <div class="icon-box bg-warning bg-opacity-10 text-warning me-3"><i class="bi bi-funnel-fill"></i></div>
          <div>
            <h6 class="text-muted mb-0">Taxa de Conversão</h6>
            <h3 class="fw-bold mb-0">{{ taxa_conversao }}%</h3>
            <div class="progress mt-2" style="height: 6px; width: 100px;">
              <div id="progressConversao" class="progress-bar bg-warning" role="progressbar"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <h5 class="fw-bold text-secondary mb-3"><i class="bi bi-megaphone-fill me-2"></i>Aquisição</h5>
  <div class="row g-4 mb-5">
    <div class="col-md-6">
      <div class="card card-chart shadow-sm">
        <div class="card-header-chart">
          <h6 class="fw-bold mb-0">Origem dos Leads (CRM)</h6>
          <small class="text-muted">Fonte do contato inicial</small>
        </div>
        <div class="card-body"><div class="chart-container"><canvas id="chartFontes"></canvas></div></div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card card-chart shadow-sm">
        <div class="card-header-chart">
          <h6 class="fw-bold mb-0">Canal de Aquisição (Pesquisa)</h6>
          <small class="text-muted">Resposta dos alunos matriculados</small>
        </div>
        <div class="card-body"><div class="chart-container"><canvas id="chartConheceu"></canvas></div></div>
      </div>
    </div>
  </div>

  <h5 class="fw-bold text-secondary mb-3"><i class="bi bi-person-badge-fill me-2"></i>Perfil da Persona</h5>
  <div class="row g-4 mb-5">
    <div class="col-md-4">
      <div class="card card-chart shadow-sm">
        <div class="card-header-chart">
          <h6 class="fw-bold mb-0">Faixa Etária</h6>
        </div>
        <div class="card-body"><div class="chart-container"><canvas id="chartFaixa"></canvas></div></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-chart shadow-sm">
        <div class="card-header-chart">
          <h6 class="fw-bold mb-0">Escolaridade</h6>
        </div>
        <div class="card-body"><div class="chart-container"><canvas id="chartEscolaridade"></canvas></div></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-chart shadow-sm">
        <div class="card-header-chart">
          <h6 class="fw-bold mb-0">Objetivo Principal</h6>
        </div>
        <div class="card-body"><div class="chart-container"><canvas id="chartObjetivo"></canvas></div></div>
      </div>
    </div>
  </div>

  <div class="row mb-5">
    <div class="col-12">
      <div class="card card-chart shadow-sm">
        <div class="card-header-chart">
          <h6 class="fw-bold mb-0">Áreas de Atuação Profissional (Top 8)</h6>
          <small class="text-muted">Áreas mais comuns entre os alunos</small>
        </div>
        <div class="card-body"><div class="chart-container" style="height: 300px;"><canvas id="chartArea"></canvas></div></div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Paletas de Cores
  const colorsPrimary = ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754'];
  const colorsPastel = ['#a2d2ff', '#bde0fe', '#ffafcc', '#ffc8dd', '#cdb4db', '#ffd6a5', '#fdffb6', '#caffbf'];

  // Dados do Django (Parsed)
  const dadosFontes = JSON.parse("{{ dados_fontes|escapejs }}");
  const dadosFaixa = JSON.parse("{{ dados_faixa|escapejs }}");
  const dadosConheceu = JSON.parse("{{ dados_conheceu|escapejs }}");
  const dadosEscolaridade = JSON.parse("{{ dados_escolaridade|escapejs }}");
  const dadosArea = JSON.parse("{{ dados_area|escapejs }}");
  const dadosObjetivo = JSON.parse("{{ dados_objetivo|escapejs }}");

  // Ajuste barra de progresso
  const taxaConversao = "{{ taxa_conversao }}".replace(',', '.');
  const pb = document.getElementById('progressConversao');
  if(pb) pb.style.width = taxaConversao + '%';

  // Configuração Genérica para Doughnut/Pie
  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } }
  };

  // 1. Origem (CRM) - Doughnut
  new Chart(document.getElementById('chartFontes'), {
    type: 'doughnut',
    data: {
      labels: dadosFontes.labels,
      datasets: [{ data: dadosFontes.data, backgroundColor: colorsPrimary, borderWidth: 0 }]
    },
    options: commonOptions
  });

  // 2. Canal (Pesquisa) - Pie
  new Chart(document.getElementById('chartConheceu'), {
    type: 'pie',
    data: {
      labels: dadosConheceu.labels,
      datasets: [{ data: dadosConheceu.data, backgroundColor: colorsPrimary, borderWidth: 0 }]
    },
    options: commonOptions
  });

  // 3. Faixa Etária - Bar
  new Chart(document.getElementById('chartFaixa'), {
    type: 'bar',
    data: {
      labels: dadosFaixa.labels,
      datasets: [{ label: 'Alunos', data: dadosFaixa.data, backgroundColor: '#0d6efd', borderRadius: 4 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false } } },
      plugins: { legend: { display: false } }
    }
  });

  // 4. Escolaridade - Bar (Horizontal ou Vertical Simples)
  new Chart(document.getElementById('chartEscolaridade'), {
    type: 'bar',
    data: {
      labels: dadosEscolaridade.labels,
      datasets: [{ label: 'Alunos', data: dadosEscolaridade.data, backgroundColor: '#198754', borderRadius: 4 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false } } },
      plugins: { legend: { display: false } }
    }
  });

  // 5. Objetivo - Polar Area (Para variar o visual)
  new Chart(document.getElementById('chartObjetivo'), {
    type: 'polarArea',
    data: {
      labels: dadosObjetivo.labels,
      datasets: [{ data: dadosObjetivo.data, backgroundColor: colorsPastel, borderWidth: 1 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: { r: { ticks: { display: false } } },
      plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } }
    }
  });

  // 6. Área de Atuação - Horizontal Bar (Melhor para ler nomes longos)
  new Chart(document.getElementById('chartArea'), {
    type: 'bar',
    data: {
      labels: dadosArea.labels,
      datasets: [{ label: 'Alunos', data: dadosArea.data, backgroundColor: '#6f42c1', borderRadius: 4 }]
    },
    options: {
      indexAxis: 'y', // Barra Horizontal
      responsive: true, maintainAspectRatio: false,
      scales: { x: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });
</script>

</body>
</html>